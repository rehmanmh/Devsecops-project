pipeline {
    agent any

    tools {
        maven 'maven3'
    }

    environment {
        SCANNER_HOME = tool 'sonar-scanner'
    }

    stages {

        stage('Checkout') {
            steps {
                git branch: 'main',
                    url: '<GITLAB_REPO_URL>',
                    credentialsId: 'jenkins-integration'
            }
        }

        stage('Compile') {
            steps {
                sh 'mvn compile'
            }
        }

        stage('Test') {
            steps {
                sh 'mvn test'
            }
        }

        stage('Trivy File System Scan') {
            steps {
                sh '''
                trivy fs --exit-code 1 \
                         --severity HIGH,CRITICAL \
                         .
                '''
            }
        }

        stage('OWASP Dependency Check') {
            steps {
                dependencyCheck additionalArguments: '--scan . --format HTML --format XML --disableAssembly',
                                odcInstallation: 'dependency-check'
            }
        }

        stage('SonarQube Analysis') {
            environment {
                SONAR_TOKEN = credentials('sonarqube-token')
            }
            steps {
                withSonarQubeEnv('sonarqube-server') {
                    sh """
                    ${SCANNER_HOME}/bin/sonar-scanner \
                    -Dsonar.projectKey=BankApp \
                    -Dsonar.projectName=BankApp \
                    -Dsonar.java.binaries=target \
                    -Dsonar.login=$SONAR_TOKEN
                    """
                }
            }
        }

        stage('Quality Gate') {
            steps {
                timeout(time: 2, unit: 'MINUTES') {
                    waitForQualityGate abortPipeline: true
                }
            }
        }

        stage('Build & Publish to Nexus') {
            steps {
                withMaven(globalMavenSettingsConfig: 'devops-shack-settings') {
                    sh 'mvn deploy -DskipTests'
                }
            }
        }

        stage('Docker Build') {
            steps {
                sh 'docker build -t <YOUR_DOCKER_USER>/bankapp:latest .'
            }
        }

        stage('Trivy Image Scan') {
            steps {
                sh '''
                trivy image --exit-code 1 \
                            --severity HIGH,CRITICAL \
                            <YOUR_DOCKER_USER>/bankapp:latest
                '''
            }
        }

        stage('Docker Push') {
            steps {
                withDockerRegistry(credentialsId: 'docker-cred-id') {
                    sh 'docker push <YOUR_DOCKER_USER>/bankapp:latest'
                }
            }
        }

        stage('Deploy to Kubernetes') {
            steps {
                withKubeConfig(credentialsId: 'k8s-token') {
                    sh 'kubectl apply -f k8s/deployment.yaml -n webapps'
                    sh 'kubectl apply -f k8s/service.yaml -n webapps'
                }
            }
        }

        stage('Verify Deployment') {
            steps {
                sh 'kubectl get svc -n webapps'
            }
        }
    }
}
